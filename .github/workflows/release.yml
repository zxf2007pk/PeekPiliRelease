name: è‡ªåŠ¨å‘å¸ƒ Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        default: 'v1.0.0'
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜'
        required: false
        default: 'æ–°ç‰ˆæœ¬å‘å¸ƒ'
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®ç‰ˆæœ¬å·
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ç‰ˆæœ¬å·: $VERSION"
      
      - name: åˆ›å»º Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: Release ${{ steps.version.outputs.version }}
          body: |
            ## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
            
            ${{ github.event.inputs.release_notes || 'æ–°ç‰ˆæœ¬å‘å¸ƒ' }}
            
            ## ğŸ“¦ ä¸‹è½½å®‰è£…åŒ…
            
            è¯·ä»ä¸‹æ–¹ Assets ä¸­ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…ã€‚
            
            ## ğŸ“ æ›´æ–°å†…å®¹
            
            - æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹
            
            ## âš ï¸ æ³¨æ„äº‹é¡¹
            
            - è¯·æ ¹æ®æ‚¨çš„è®¾å¤‡å¹³å°é€‰æ‹©åˆé€‚çš„å®‰è£…åŒ…
            - å®‰è£…å‰è¯·å¤‡ä»½é‡è¦æ•°æ®
          draft: false
          prerelease: false
      
      - name: ä¸Šä¼  Release æ–‡ä»¶
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./release/
          asset_name: release-assets.zip
          asset_content_type: application/zip
        continue-on-error: true
      
      - name: ä¸Šä¼ å•ä¸ªæ–‡ä»¶
        run: |
          cd release
          for file in *; do
            if [ -f "$file" ]; then
              echo "ä¸Šä¼ æ–‡ä»¶: $file"
              curl -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: $(file -b --mime-type "$file")" \
                --data-binary @"$file" \
                "${{ steps.create_release.outputs.upload_url }}?name=$file" || true
            fi
          done

